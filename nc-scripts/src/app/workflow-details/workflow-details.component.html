<div class="content-page">
  <div class="descriptor">
    <h1>Workflow Editor</h1>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-11 value">
        <mat-form-field>
          <mat-label>Name</mat-label>
          <input matInput [(ngModel)]="workflow.name" (ngModelChange)="changed=true">
        </mat-form-field>
      </div>
      <div class="col-1 value">
        <mat-form-field>
          <mat-label>Revision</mat-label>
          <input matInput [(ngModel)]="workflow.revision" (ngModelChange)="loadRevision()">
        </mat-form-field>
      </div>
    </div>
  </div>

  <div class="container workflowcontainer">
    <div class="row workflowgraph" (click)="resetTransition()">
      <ngx-graph class="chart-container" layout="dagreCluster" [nodes]="nodes" [links]="transitions" [clusters]="clusters" [update$]="updateGraph$" (contextmenu)="onContextMenu($event)" [draggingEnabled]="false">
        <ng-template #defsTemplate>
          <svg:marker id="arrow" viewBox="0 -5 10 10" refX="8" refY="0" markerWidth="4" markerHeight="4" orient="auto">
            <svg:path d="M0,-5L10,0L0,5" class="arrow-head" />
          </svg:marker>
        </ng-template>

        <ng-template #nodeTemplate let-node>
          <svg:g class="node" ngx-tooltip [tooltipPlacement]="'top'" [tooltipType]="'tooltip'" [tooltipTitle]="node.label" (click)="nodeClick($event, node)" [attr.width]="node.dimension.width" [attr.height]="node.dimension.height" (dblclick)="editNode($event, node)">
            <svg:rect [attr.width]="node.dimension.width" height="15" fill="#606060" />
            <svg:text alignment-baseline="central" [attr.x]="5" [attr.y]="7.5" font-size="10" fill="#FFFFFF">
              {{NodeType.getNodeTypeName(node.data.node.type)}}
            </svg:text>
            <svg:rect
              class="workflownode"
              y="15"
              [attr.width]="node.dimension.width"
              height="65"
              [ngClass]="{
                'nodetypestart': NodeType.getNodeTypeValue(node.data.node.type)===NodeType.Start, 
                'nodetypeexpression': NodeType.getNodeTypeValue(node.data.node.type)===NodeType.Expression, 
                'nodetypescript': NodeType.getNodeTypeValue(node.data.node.type)===NodeType.Script, 
                'nodetypeworkflow': NodeType.getNodeTypeValue(node.data.node.type)===NodeType.Workflow, 
                'nodetypebinaryoperation': NodeType.getNodeTypeValue(node.data.node.type)===NodeType.BinaryOperation, 
                'nodetypevalue': NodeType.getNodeTypeValue(node.data.node.type)===NodeType.Value, 
                'nodetypesuspend': NodeType.getNodeTypeValue(node.data.node.type)===NodeType.Suspend, 
                'nodetypecall': NodeType.getNodeTypeValue(node.data.node.type)===NodeType.Call, 
                'nodetypelog': NodeType.getNodeTypeValue(node.data.node.type)===NodeType.Log, 
                'nodetypeiterator': NodeType.getNodeTypeValue(node.data.node.type)===NodeType.Iterator,
                'nodehighlight': node.data.highlighted }"
            />              
            <svg:text alignment-baseline="central" text-anchor="middle" [attr.x]="node.dimension.width*0.5" y="47.5">
              {{node.data.node.name}}
            </svg:text>
            <ng-container *ngIf="node.data.node.variable">
              <svg:rect y="80" [attr.width]="node.dimension.width" height="15" fill="#404060" />
              <svg:text alignment-baseline="central" [attr.x]="5" [attr.y]="87.5" font-size="10" fill="#FFFFFF">
                той {{node.data.node.variable}}
              </svg:text>
            </ng-container>
          </svg:g>
        </ng-template>
        <ng-template #linkTemplate let-link>
          <svg:g class="edge" (dblclick)="editTransition($event, link)" (click)="edgeClick($event, link)">
            <svg:path class="line" [ngClass]="{'transitionhighlight': link.data.highlighted, 'transitionerror': !link.data.highlighted && link.data.transition.type==='Error', 'transition': !link.data.highlighted && link.data.transition.type==='Standard', 'transitionloop': !link.data.highlighted && link.data.transition.type==='Loop' }" stroke-width="3" marker-end="url(#arrow)"></svg:path>
            <svg:text class="edge-label" text-anchor="middle">
              <textPath
                class="text-path"
                [attr.href]="'#' + link.id"
                [style.dominant-baseline]="link.dominantBaseline"
                startOffset="50%"
              >
                {{ link.data.transition.condition }}
              </textPath>
            </svg:text>
          </svg:g>
        </ng-template>
        <ng-template #clusterTemplate let-cluster>
          <svg:g class="node cluster">
            <svg:rect rx="5" ry="5" [attr.width]="cluster.dimension.width" [attr.height]="cluster.dimension.height" [attr.fill]="'#404040'" />
          </svg:g>
        </ng-template>
      </ngx-graph>
    </div>
  </div>
  <p></p>
  <div class="container">
    <div class="actionbutton">
      <button mat-raised-button color="primary" [disabled]="!changed" (click)="save()">Save</button>
    </div>
    <div class="actionbutton">
      <button mat-raised-button color="primary" (click)="startTest()">Test</button>
    </div>
  </div>
</div>